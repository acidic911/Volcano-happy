<!doctype html>
<!-- Volcano Hybrid • Web Controller (Ultra Edition)
     Everything in one file. Supports iPhone (Bluefy/WebBLE) and Desktop Chrome.
     Author: you + me
     License: do what you want; don’t blame us if you melt your balloon :)
-->
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#0b0b0c">
<title>Volcano Hybrid • Web Controller</title>
<style>
:root{color-scheme:dark}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:#0b0b0c;color:#eaeaea;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  line-height:1.35;
}
.wrap{max-width:1080px;margin:0 auto;padding:16px}
h1{letter-spacing:.08em;margin:10px 0 14px}
h2,h3{margin:10px 0 8px}
.card{
  background:#101115;border:1px solid #1c1c21;border-radius:14px;
  padding:14px;margin:12px 0; box-shadow:0 0 0 1px rgba(255,255,255,.02) inset;
}
.row{margin:6px 0}
.small{opacity:.85}
kbd,code{background:#0f0f12;border:1px solid #2d2d32;border-radius:6px;padding:2px 6px}
button{
  background:#1c1c1f;color:#eaeaea;border:1px solid #2d2d32;
  padding:10px 14px;border-radius:12px;margin:6px;cursor:pointer;
}
button:hover{background:#232327}
button[disabled]{opacity:.5;cursor:not-allowed}
input,select,textarea{
  background:#0f0f12;color:#eaeaea;border:1px solid #2d2d32;border-radius:10px;
  padding:8px;outline:none;
}
input[type=number]{width:140px}
input[type=text]{width:100%;max-width:560px}
textarea{width:100%;min-height:80px}
pre{
  background:#0f0f12;border:1px solid #2d2d32;border-radius:10px;padding:10px;
  max-height:360px;overflow:auto;font-size:12px;white-space:pre-wrap;word-break:break-word;
}
.grid{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.cols{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
.table{width:100%;border-collapse:collapse;font-size:13px}
.table th,.table td{border-bottom:1px solid #1c1c21;padding:6px 8px;text-align:left}
.badge{display:inline-block;padding:0 8px;border-radius:999px;border:1px solid #2d2d32;background:#0f0f12}
.success{color:#7dffa4}.warn{color:#ffd36b}.err{color:#ff8585}
hr{border:none;border-top:1px solid #1c1c21;margin:12px 0}
.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto}
.help{font-size:12px;opacity:.9}
</style>
</head>
<body>
<div class="wrap">
  <h1>VOLCANO HYBRID • Web Controller</h1>

  <!-- Connection -->
  <div class="card">
    <div class="row small">
      iPhone: open in <b>Bluefy/WebBLE</b> (Safari doesn’t support Web Bluetooth). Close the official S&B app first.
    </div>
    <div class="flex">
      <div>Status: <span id="status" class="badge">Idle</span></div>
      <div class="right">Device: <span id="devName">—</span></div>
    </div>
    <div class="grid">
      <button id="btnConnectBroad">Connect (Broad scan)</button>
      <button id="btnConnectVolcano">Connect (Search “VOLCANO”)</button>
      <input id="svcInput" type="text" placeholder="Service UUID to filter (optional)">
      <button id="btnConnectService">Connect (By Service)</button>
      <button id="btnOptional">Reconnect (Aggressive optionalServices)</button>
      <label class="small" style="display:flex;align-items:center;gap:6px">
        <input id="autoReconnect" type="checkbox"> Auto-reconnect
      </label>
    </div>
    <div class="grid">
      <button id="btnDisconnect">Disconnect</button>
      <button id="btnDiscover">Discover Services/Characteristics</button>
      <button id="btnStopNotify">Stop All Notifications</button>
      <button id="btnPing">Ping RTT</button>
      <span id="rtt" class="small">RTT: — ms</span>
    </div>
  </div>

  <!-- Readouts -->
  <div class="card">
    <h3>Readouts</h3>
    <div class="grid">
      <div>Current temp: <b><span id="curTemp">—</span> °C</b></div>
      <div>Setpoint: <b><span id="sp">—</span> °C</b></div>
      <div>Battery: <b><span id="batt">—</span>%</b></div>
    </div>
  </div>

  <!-- Controls -->
  <div class="card">
    <h3>Controls</h3>
    <div class="grid">
      <input type="number" id="inpSet" min="150" max="225" value="190">
      <button id="btnSet">Set Temp</button>
      <button id="btnHeater">Heater On/Off</button>
      <button id="btnFan">Fan On/Off</button>
      <button id="btnProbeToggles">Probe Toggles</button>
      <button id="btnMonitorAll">Monitor All Notifies</button>
    </div>
    <div class="grid">
      <button data-preset="175,190,205">Terp Flight</button>
      <button data-preset="185,195,205">Balanced</button>
      <button data-preset="190,205,215">Medical</button>
    </div>
    <div class="help">Tip: If fan/heater don’t respond, hit <b>Monitor All Notifies</b>, press the physical buttons, copy the UUIDs that fire into Mapping below, then Save.</div>
  </div>

  <!-- Mapping -->
  <div class="card">
    <h3>Mapping (edit → Save). Values are remembered locally.</h3>
    <div class="cols">
      <label>Device Info service (battery)<br>
        <input id="svcInfo" type="text" value="0000180a-0000-1000-8000-00805f9b34fb">
      </label>
      <label>Battery service<br>
        <input id="svcBatt" type="text" value="0000180f-0000-1000-8000-00805f9b34fb">
      </label>
      <label>Temp/Setpoint service<br>
        <input id="svcTemp" type="text" value="10110000-5354-4F52-5A26-4249434B454C">
      </label>
      <label>Temp (notify, tenths °C)<br>
        <input id="charTempN" type="text" value="10110001-5354-4F52-5A26-4249434B454C">
      </label>
      <label>Setpoint (notify)<br>
        <input id="charSpN" type="text" value="1011000E-5354-4F52-5A26-4249434B454C">
      </label>
      <label>Setpoint (write, tenths °C)<br>
        <input id="charSpW" type="text" value="1011000D-5354-4F52-5A26-4249434B454C">
      </label>
      <label>Heater command (write)<br>
        <input id="charHeater" type="text" value="1011000F-5354-4F52-5A26-4249434B454C">
      </label>
      <label>Fan command (write)<br>
        <input id="charFan" type="text" value="1011000C-5354-4F52-5A26-4249434B454C">
      </label>
    </div>
    <div class="grid">
      <button id="btnSaveMap">Save Mapping</button>
      <button id="btnClearMap">Clear Mapping</button>
      <button id="btnExportMap">Export Mapping</button>
      <button id="btnImportMap">Import Mapping</button>
    </div>
    <textarea id="mapIO" placeholder="Mapping JSON for import/export (optional)"></textarea>
  </div>

  <!-- Raw GATT tools -->
  <div class="card">
    <h3>Raw GATT Tools</h3>
    <div class="cols">
      <label>Characteristic UUID<br>
        <input id="rawChar" type="text" placeholder="e.g. 10110001-5354-4F52-5A26-4249434B454C">
      </label>
      <label>Payload (hex for write, space-separated)<br>
        <input id="rawHex" type="text" placeholder="e.g. 01 or 6e 07 or 6e 07 00 00">
      </label>
    </div>
    <div class="grid">
      <button id="btnRawRead">Read</button>
      <button id="btnRawNotify">Subscribe</button>
      <button id="btnRawWrite">Write</button>
    </div>
  </div>

  <!-- Diagnostics -->
  <div class="card">
    <h3>Discovery Diagnostics</h3>
    <table class="table" id="diag"><thead>
      <tr><th>Service UUID</th><th>Characteristic UUID</th><th>Props</th></tr>
    </thead><tbody></tbody></table>
  </div>

  <!-- Logs -->
  <div class="card">
    <h3>Logs</h3>
    <pre id="log"></pre>
  </div>
</div>

<script>
/* =========================================================================================
   CONSTANTS / DEFAULTS
========================================================================================= */
const DEFAULTS = {
  svcInfo : "0000180a-0000-1000-8000-00805f9b34fb",
  svcBatt : "0000180f-0000-1000-8000-00805f9b34fb",
  svcTemp : "10110000-5354-4F52-5A26-4249434B454C",
  tempN   : "10110001-5354-4F52-5A26-4249434B454C",
  spN     : "1011000E-5354-4F52-5A26-4249434B454C",
  spW     : "1011000D-5354-4F52-5A26-4249434B454C",
  heater  : "1011000F-5354-4F52-5A26-4249434B454C",
  fan     : "1011000C-5354-4F52-5A26-4249434B454C",
  ctrlSvc : "00000001-1989-0108-1234-123456789ABC",
  ctrlWr  : "00000002-1989-0108-1234-123456789ABC",
  ctrlNt  : "00000003-1989-0108-1234-123456789ABC"
};
const CANDIDATE_TOGGLES = [
  // 1011 (temp/setpoint block)
  "1011000F-5354-4F52-5A26-4249434B454C",
  "1011000C-5354-4F52-5A26-4249434B454C",
  // 1010 (alt controls on some S&B devices)
  "1010000C-5354-4F52-5A26-4249434B454C",
  "1010000D-5354-4F52-5A26-4249434B454C",
  // 1013 (misc/commands seen on your scans)
  "10130001-5354-4F52-5A26-4249434B454C",
  "10130002-5354-4F52-5A26-4249434B454C",
  "10130003-5354-4F52-5A26-4249434B454C",
  "10130004-5354-4F52-5A26-4249434B454C",
  "10130005-5354-4F52-5A26-4249434B454C",
  "10130006-5354-4F52-5A26-4249434B454C",
  "10130007-5354-4F52-5A26-4249434B454C",
  "10130008-5354-4F52-5A26-4249434B454C",
  "10130009-5354-4F52-5A26-4249434B454C",
  "1013000A-5354-4F52-5A26-4249434B454C",
  "1013000B-5354-4F52-5A26-4249434B454C",
  "101300FF-5354-4F52-5A26-4249434B454C"
];
const PRESS_VARIANTS   = [ Uint8Array.of(1), Uint8Array.of(1,0), Uint8Array.of(1,0,0,0) ];
const RELEASE_VARIANTS = [ Uint8Array.of(0), Uint8Array.of(0,0), Uint8Array.of(0,0,0,0) ];
const MIN_C = 150, MAX_C = 225;

/* =========================================================================================
   UI ELEMENTS
========================================================================================= */
const statusEl = document.getElementById('status');
const devName  = document.getElementById('devName');
const logEl    = document.getElementById('log');
const curTemp  = document.getElementById('curTemp');
const spEl     = document.getElementById('sp');
const battEl   = document.getElementById('batt');
const rttEl    = document.getElementById('rtt');

const svcInput = document.getElementById('svcInput');
const svcInfo  = document.getElementById('svcInfo');
const svcBatt  = document.getElementById('svcBatt');
const svcTemp  = document.getElementById('svcTemp');
const charTempN= document.getElementById('charTempN');
const charSpN  = document.getElementById('charSpN');
const charSpW  = document.getElementById('charSpW');
const charHeater = document.getElementById('charHeater');
const charFan    = document.getElementById('charFan');
const mapIO    = document.getElementById('mapIO');

const inpSet   = document.getElementById('inpSet');
const diagBody = document.querySelector('#diag tbody');
const autoReconnect = document.getElementById('autoReconnect');

/* =========================================================================================
   STATE
========================================================================================= */
let device, server;
let chars = new Map();           // key: "service|char" -> BluetoothRemoteGATTCharacteristic
let notifications = new Set();   // set of characteristic UUIDs we started notifications on
let discovered = false;
let reconnecting = false;

/* =========================================================================================
   UTILITIES
========================================================================================= */
function log(s){ console.log(s); logEl.textContent=(s+"\n"+logEl.textContent).slice(0,100000); }
function setStatus(s){ statusEl.textContent=s; }
function clampC(v){ v=Number(v)||0; return Math.max(MIN_C, Math.min(MAX_C, Math.round(v))); }
function toTenths2(c){ const t=Math.round(c*10), b=new ArrayBuffer(2); new DataView(b).setUint16(0,t,true); return new Uint8Array(b); }
function toTenths4(c){ const t=Math.round(c*10), b=new ArrayBuffer(4); new DataView(b).setUint32(0,t,true); return new Uint8Array(b); }
function hex(u8){ return Array.from(u8).map(b=>b.toString(16).padStart(2,'0')).join(' '); }
function parseHex(s){ return Uint8Array.from((s||'').trim().split(/\s+/).filter(Boolean).map(h=>parseInt(h,16)||0)); }
function optionalSvcList(){
  return [
    DEFAULTS.svcInfo, DEFAULTS.svcBatt, DEFAULTS.ctrlSvc,
    "10100000-5354-4F52-5A26-4249434B454C",
    "10110000-5354-4F52-5A26-4249434B454C",
    "10130000-5354-4F52-5A26-4249434B454C"
  ];
}

/* smart write: prefer with-response, fallback to no-response */
async function writeSmart(ch, bytes){
  try{
    if(ch.properties.write && ch.writeValue){ await ch.writeValue(bytes); }
    else { await ch.writeValueWithoutResponse(bytes); }
  }catch(e){
    if(ch.writeValueWithoutResponse){ await ch.writeValueWithoutResponse(bytes); }
    else throw e;
  }
}

/* find char from cache by uuid */
function getCharByUUID(uuid){
  for(const [key,ch] of chars.entries()){
    if(key.endsWith('|'+uuid)) return ch;
  }
  throw new Error('Characteristic not found: '+uuid);
}

/* subscribe helper */
async function subscribeIf(ch, cb){
  try{
    if(ch && (ch.properties.notify || ch.properties.indicate)){
      await ch.startNotifications();
      ch.addEventListener('characteristicvaluechanged', e => cb(e.target.value, ch));
      notifications.add(ch.uuid);
    }
  }catch(e){ log('subscribe failed: '+e); }
}

/* stop all notifies */
async function stopAllNotifies(){
  for(const [key,ch] of chars.entries()){
    if(notifications.has(ch.uuid)){
      try{ await ch.stopNotifications(); }catch{}
    }
  }
  notifications.clear();
  log('Stopped all notifications.');
}

/* =========================================================================================
   MAPPING SAVE/LOAD/IMPORT/EXPORT
========================================================================================= */
function saveMapping(){
  const m={
    svcInfo:  svcInfo.value.trim(),
    svcBatt:  svcBatt.value.trim(),
    svcTemp:  svcTemp.value.trim(),
    charTempN:charTempN.value.trim(),
    charSpN:  charSpN.value.trim(),
    charSpW:  charSpW.value.trim(),
    charHeater:charHeater.value.trim(),
    charFan:  charFan.value.trim()
  };
  localStorage.setItem('volcanoMap', JSON.stringify(m));
  log('Mapping saved.');
}
function loadMapping(){
  try{
    const m=JSON.parse(localStorage.getItem('volcanoMap')||'{}');
    if(m.svcInfo)  svcInfo.value = m.svcInfo;
    if(m.svcBatt)  svcBatt.value = m.svcBatt;
    if(m.svcTemp)  svcTemp.value = m.svcTemp;
    if(m.charTempN)charTempN.value = m.charTempN;
    if(m.charSpN)  charSpN.value = m.charSpN;
    if(m.charSpW)  charSpW.value = m.charSpW;
    if(m.charHeater)charHeater.value = m.charHeater;
    if(m.charFan)  charFan.value = m.charFan;
  }catch{}
}
function exportMapping(){ mapIO.value = localStorage.getItem('volcanoMap') || ''; }
function importMapping(){
  try{
    localStorage.setItem('volcanoMap', mapIO.value.trim());
    loadMapping();
    log('Mapping imported.');
  }catch(e){ alert('Import failed: '+e); }
}
loadMapping();

/* =========================================================================================
   CONNECT / RECONNECT
========================================================================================= */
async function finishConnect(picked){
  device = picked;
  devName.textContent = device.name || device.id || 'Volcano';
  setStatus('Connecting…');
  server = await device.gatt.connect();
  setStatus('Connected');

  // auto-reconnect
  device.addEventListener('gattserverdisconnected', async ()=>{
    setStatus('Disconnected');
    if(autoReconnect.checked && !reconnecting){
      reconnecting = true;
      log('Device disconnected. Trying auto-reconnect…');
      try{
        await device.gatt.connect();
        setStatus('Connected');
        await discoverAll();
        setStatus('Ready');
        log('Auto-reconnect success.');
      }catch(e){ log('Auto-reconnect failed: '+e); }
      reconnecting = false;
    }
  });

  await discoverAll();
  await wakeSession(); // sometimes required before control writes
  setStatus('Ready');
}

async function connectBroad(){
  if(!navigator.bluetooth){ alert('Use Bluefy/WebBLE on iPhone.'); return; }
  setStatus('Scanning…');
  const dev = await navigator.bluetooth.requestDevice({
    acceptAllDevices:true,
    optionalServices: optionalSvcList()
  });
  await finishConnect(dev);
}
async function connectVolcano(){
  if(!navigator.bluetooth){ alert('Use Bluefy/WebBLE on iPhone.'); return; }
  setStatus('Scanning (VOLCANO)…');
  const dev = await navigator.bluetooth.requestDevice({
    filters:[{namePrefix:"VOLCANO"},{namePrefix:"S&B VOLCANO"}],
    optionalServices: optionalSvcList()
  });
  await finishConnect(dev);
}
async function connectByService(){
  if(!navigator.bluetooth){ alert('Use Bluefy/WebBLE on iPhone.'); return; }
  const svc = (svcInput.value||'').trim();
  setStatus('Scanning (by service)…');
  const dev = await navigator.bluetooth.requestDevice({
    filters: svc ? [{services:[svc]}] : undefined,
    acceptAllDevices: svc ? false : true,
    optionalServices: optionalSvcList().concat(svc? [svc] : [])
  });
  await finishConnect(dev);
}
async function reconnectOptional(){
  if(!navigator.bluetooth){ alert('Use Bluefy/WebBLE on iPhone.'); return; }
  setStatus('Re-scanning (aggressive optionalServices)…');
  const dev = await navigator.bluetooth.requestDevice({
    acceptAllDevices:true,
    optionalServices: optionalSvcList().concat([DEFAULTS.ctrlSvc, DEFAULTS.svcTemp])
  });
  await finishConnect(dev);
}
async function disconnectNow(){
  try{ await stopAllNotifies(); }catch{}
  try{ if(device && device.gatt.connected) device.gatt.disconnect(); }catch{}
  setStatus('Disconnected');
  log('Disconnected.');
}

/* =========================================================================================
   DISCOVERY / DIAGNOSTICS
========================================================================================= */
async function discoverAll(){
  chars.clear(); notifications.clear(); discovered=false;
  diagBody.innerHTML='';
  const services = await server.getPrimaryServices();
  for(const svc of services){
    let chs=[];
    try{ chs = await svc.getCharacteristics(); }catch{ chs=[]; }
    for(const ch of chs){
      const key = `${svc.uuid}|${ch.uuid}`;
      chars.set(key, ch);
      const props = {read:!!ch.properties.read, write:!!(ch.properties.write||ch.properties.writeWithoutResponse), notify:!!ch.properties.notify};
      log(`FOUND ${key} props=${JSON.stringify(props)}`);

      // show in diagnostics table
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><code>${svc.uuid}</code></td><td><code>${ch.uuid}</code></td><td>${Object.keys(props).filter(k=>props[k]).join(', ')||'—'}</td>`;
      diagBody.appendChild(tr);

      // quick READ for snapshot
      if(ch.properties.read){
        try{
          const v=await ch.readValue();
          log(`READ ${key} = [${Array.from(new Uint8Array(v.buffer)).join(', ')}]`);
        }catch{}
      }
    }
  }

  // Subscribe to the mapped notifies
  try{
    const chT = getCharByUUID(charTempN.value.trim());
    await subscribeIf(chT, dv=>{
      if(dv.byteLength>=2){
        const t = new DataView(dv.buffer).getInt16(0,true)/10;
        if(isFinite(t)) curTemp.textContent = t.toFixed(1);
      }
      log(`[temp] ${hex(new Uint8Array(dv.buffer))}`);
    });
  }catch(e){ log('Temp notify subscribe failed: '+e); }

  try{
    const chS = getCharByUUID(charSpN.value.trim());
    await subscribeIf(chS, dv=>{
      if(dv.byteLength>=2){
        const s=new DataView(dv.buffer).getInt16(0,true);
        if(isFinite(s)) spEl.textContent=s;
      }
      log(`[setpoint] ${hex(new Uint8Array(dv.buffer))}`);
    });
  }catch(e){ log('Setpoint notify subscribe failed: '+e); }

  // Try battery if exposed
  try{
    const battLevelUUID = "00002a19-0000-1000-8000-00805f9b34fb";
    const chB = getCharByUUID(battLevelUUID);
    await subscribeIf(chB, dv=>{
      if(dv.byteLength>=1){ battEl.textContent = dv.getUint8(0); }
    });
    try{
      const v=await chB.readValue(); if(v.byteLength>=1){ battEl.textContent=v.getUint8(0); }
    }catch{}
  }catch{}

  discovered = true;
  log('Discovery complete.');
}

/* wake session on the control write char (some devices want a nudge) */
async function wakeSession(){
  try{
    const ch = getCharByUUID(DEFAULTS.ctrlWr);
    await writeSmart(ch, Uint8Array.of(1));
    await new Promise(r=>setTimeout(r,100));
    await writeSmart(ch, Uint8Array.of(0));
    log('Sent wake pulse on control write char.');
  }catch{ /* ignore */ }
}

/* =========================================================================================
   ACTIONS: Temp / Heater / Fan
========================================================================================= */
async function setTemp(){
  try{
    if(!discovered) await discoverAll();
    const c = clampC(inpSet.value);
    spEl.textContent = c;
    const ch = getCharByUUID(charSpW.value.trim());
    try{ await writeSmart(ch, toTenths2(c)); }
    catch{ await writeSmart(ch, toTenths4(c)); }
    log(`→ setpoint write ${c} °C`);
  }catch(e){ log('Set temp error: '+e); alert('Set temp failed: '+e); }
}

async function pulseUUID(uuid,label){
  try{
    const ch = getCharByUUID(uuid);
    let ok=false;
    for(let i=0;i<PRESS_VARIANTS.length && !ok;i++){
      try{
        await writeSmart(ch, PRESS_VARIANTS[i]);
        await new Promise(r=>setTimeout(r,150));
        await writeSmart(ch, RELEASE_VARIANTS[i]);
        ok=true;
        log(`→ ${label} pulse sent (${uuid}) using variant ${i+1}`);
      }catch(_){}
    }
    if(!ok) throw new Error('all write variants failed');
  }catch(e){ log(`${label} error: ${e}`); alert(`${label} failed: ${e}`); }
}
async function toggleHeater(){ await pulseUUID(charHeater.value.trim(),'heater'); }
async function toggleFan(){ await pulseUUID(charFan.value.trim(),'fan'); }

/* brute probe: try all candidates and all variants */
async function probeToggles(){
  if(!discovered) await discoverAll();
  const worked=[];
  for(const u of CANDIDATE_TOGGLES){
    try{
      const ch = getCharByUUID(u);
      for(let i=0;i<PRESS_VARIANTS.length;i++){
        try{
          await writeSmart(ch, PRESS_VARIANTS[i]);
          await new Promise(r=>setTimeout(r,180));
          await writeSmart(ch, RELEASE_VARIANTS[i]);
          log(`[probe] pulse OK on ${u} (variant ${i+1})`);
          worked.push([u,i+1]); break;
        }catch{}
      }
    }catch{}
  }
  if(worked.length){
    if(!charHeater.value) charHeater.value = worked[0][0];
    if(!charFan.value && worked[1]) charFan.value = worked[1][0];
    saveMapping();
    alert(`Probe found ${worked.length} writable toggles. Assign Heater/Fan if needed and Save.`);
  }else{
    alert('No obvious toggle responded. Try Monitor All and press physical buttons to see which UUIDs fire.');
  }
}

/* subscribe to every notify to watch UUIDs changing */
async function monitorAll(){
  if(!discovered) await discoverAll();
  for (const [key,ch] of chars.entries()){
    try{
      if (ch.properties.notify || ch.properties.indicate){
        await ch.startNotifications();
        ch.addEventListener('characteristicvaluechanged', e=>{
          const uuid = key.split('|')[1];
          const arr = new Uint8Array(e.target.value.buffer);
          log(`[notify] ${uuid} = ${hex(arr)}`);
        });
        notifications.add(ch.uuid);
      }
    }catch{}
  }
  alert('Monitoring all notifies. Press Fan/Heater on the Volcano and watch Logs for UUIDs that change.');
}

/* =========================================================================================
   RAW GATT TOOLS
========================================================================================= */
async function rawRead(){
  try{
    const ch = getCharByUUID((rawChar.value||'').trim());
    const v = await ch.readValue();
    log(`[raw read] ${ch.uuid} = [${hex(new Uint8Array(v.buffer))}]`);
  }catch(e){ log('raw read error: '+e); alert(e); }
}
async function rawNotify(){
  try{
    const ch = getCharByUUID((rawChar.value||'').trim());
    await subscribeIf(ch, dv => log(`[raw notify] ${ch.uuid} = [${hex(new Uint8Array(dv.buffer))}]`));
    log(`[raw notify] subscribed to ${ch.uuid}`);
  }catch(e){ log('raw notify error: '+e); alert(e); }
}
async function rawWrite(){
  try{
    const ch = getCharByUUID((rawChar.value||'').trim());
    const payload = parseHex(rawHex.value);
    await writeSmart(ch, payload);
    log(`[raw write] ${ch.uuid} <= [${hex(payload)}]`);
  }catch(e){ log('raw write error: '+e); alert(e); }
}

/* =========================================================================================
   PING RTT
========================================================================================= */
async function pingRTT(){
  const t0 = performance.now();
  try{
    // try a quick read on setpoint notify if readable; else any readable characteristic
    let ch;
    try{ ch = getCharByUUID(charSpN.value.trim()); }
    catch{
      for(const [key,c] of chars.entries()){ if(c.properties.read){ ch=c; break; } }
    }
    if(!ch){ rttEl.textContent='RTT: N/A'; return; }
    await ch.readValue();
    const dt = Math.round(performance.now()-t0);
    rttEl.textContent = `RTT: ${dt} ms`;
  }catch(e){
    rttEl.textContent='RTT: fail';
  }
}

/* =========================================================================================
   EVENT WIRING
========================================================================================= */
document.getElementById('btnConnectBroad').onclick   = connectBroad;
document.getElementById('btnConnectVolcano').onclick  = connectVolcano;
document.getElementById('btnConnectService').onclick  = connectByService;
document.getElementById('btnOptional').onclick        = reconnectOptional;
document.getElementById('btnDisconnect').onclick      = disconnectNow;

document.getElementById('btnDiscover').onclick        = async ()=>{ if(!server){alert('Connect first.');return;} await discoverAll(); };
document.getElementById('btnStopNotify').onclick      = stopAllNotifies;
document.getElementById('btnPing').onclick            = pingRTT;

document.getElementById('btnSet').onclick             = setTemp;
document.getElementById('btnHeater').onclick          = toggleHeater;
document.getElementById('btnFan').onclick             = toggleFan;
document.getElementById('btnProbeToggles').onclick    = probeToggles;
document.getElementById('btnMonitorAll').onclick      = monitorAll;

document.getElementById('btnSaveMap').onclick         = saveMapping;
document.getElementById('btnClearMap').onclick        = ()=>{ localStorage.removeItem('volcanoMap'); loadMapping(); log('Mapping cleared.'); };
document.getElementById('btnExportMap').onclick       = exportMapping;
document.getElementById('btnImportMap').onclick       = importMapping;

document.getElementById('btnRawRead').onclick         = rawRead;
document.getElementById('btnRawNotify').onclick       = rawNotify;
document.getElementById('btnRawWrite').onclick        = rawWrite;

for (const btn of document.querySelectorAll('[data-preset]')){
  btn.addEventListener('click', async ()=>{
    for (const s of btn.dataset.preset.split(',')){
      inpSet.value = parseInt(s,10);
      await setTemp();
      await new Promise(r=>setTimeout(r, 60000)); // 1 min steps
    }
  });
}
</script>
</body>
</html>
