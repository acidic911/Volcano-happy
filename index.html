<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Volcano Hybrid • Web Controller</title>
<meta name="theme-color" content="#0b0b0c">
<style>
:root{color-scheme:dark}
*{box-sizing:border-box}
body{margin:0;background:#0b0b0c;color:#eaeaea;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
.wrap{max-width:940px;margin:0 auto;padding:16px}
h1{letter-spacing:.08em;margin:10px 0 14px}
.card{background:#101115;border:1px solid #1c1c21;border-radius:14px;padding:14px;margin:10px 0}
.row{margin:6px 0}.small{opacity:.85}
button{background:#1c1c1f;color:#eaeaea;border:1px solid #2d2d32;padding:10px 14px;border-radius:12px;margin:6px;cursor:pointer}
button:hover{background:#232327}
input{padding:8px;border-radius:10px;border:1px solid #2d2d32;background:#0f0f12;color:#eaeaea}
input[type=number]{width:140px}
input[type=text]{width:100%;max-width:520px}
pre{background:#0f0f12;border:1px solid #2d2d32;border-radius:10px;padding:10px;max-height:360px;overflow:auto;font-size:12px}
.grid{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.cols{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>VOLCANO HYBRID • Web Controller</h1>

  <div class="card">
    <div class="small">iPhone: use <b>Bluefy/WebBLE</b>. Close the official S&B app first.</div>
    <div class="row">Status: <span id="status">Idle</span></div>
    <div class="grid">
      <button id="btnConnect">Connect (Broad scan)</button>
      <button id="btnDiscover">Re-discover</button>
    </div>
    <div class="row">Device: <span id="devName">—</span></div>
  </div>

  <div class="card">
    <h3>Readouts</h3>
    <div class="row">Current temp: <b><span id="curTemp">—</span> °C</b></div>
    <div class="row">Setpoint: <b><span id="sp">—</span> °C</b></div>
  </div>

  <div class="card">
    <h3>Controls</h3>
    <div class="grid">
      <input type="number" id="inpSet" min="150" max="225" value="190">
      <button id="btnSet">Set Temp</button>
      <button id="btnHeater">Heater On/Off</button>
      <button id="btnFan">Fan On/Off</button>
      <button id="btnProbe">Probe Toggles</button>
      <button id="btnMonitor">Monitor All</button>
    </div>
  </div>

  <div class="card">
    <h3>Mapping (edit if needed → Save)</h3>
    <div class="cols">
      <label>Temp service
        <input id="svcTemp" type="text" value="10110000-5354-4F52-5A26-4249434B454C">
      </label>
      <label>Temp notify (tenths °C)
        <input id="charTempN" type="text" value="10110001-5354-4F52-5A26-4249434B454C">
      </label>
      <label>Setpoint notify
        <input id="charSpN" type="text" value="1011000E-5354-4F52-5A26-4249434B454C">
      </label>
      <label>Setpoint write
        <input id="charSpW" type="text" value="1011000D-5354-4F52-5A26-4249434B454C">
      </label>
      <label>Heater command
        <input id="charHeater" type="text" value="1011000F-5354-4F52-5A26-4249434B454C">
      </label>
      <label>Fan command
        <input id="charFan" type="text" value="1011000C-5354-4F52-5A26-4249434B454C">
      </label>
    </div>
    <div class="grid">
      <button id="btnSaveMap">Save</button>
      <button id="btnClearMap">Clear</button>
    </div>
  </div>

  <div class="card">
    <h3>Logs</h3>
    <pre id="log"></pre>
  </div>
</div>

<script>
/* ---------- UI refs ---------- */
const statusEl = document.getElementById('status');
const devName  = document.getElementById('devName');
const logEl    = document.getElementById('log');
const curTemp  = document.getElementById('curTemp');
const spEl     = document.getElementById('sp');
const inpSet   = document.getElementById('inpSet');

const svcTemp  = document.getElementById('svcTemp');
const charTempN= document.getElementById('charTempN');
const charSpN  = document.getElementById('charSpN');
const charSpW  = document.getElementById('charSpW');
const charHeater = document.getElementById('charHeater');
const charFan    = document.getElementById('charFan');

/* ---------- State ---------- */
let device, server;
let chars = new Map();   // "service|char" -> characteristic
let discovered = false;
const MIN=150, MAX=225;

function log(s){ console.log(s); logEl.textContent=(s+"\n"+logEl.textContent).slice(0,70000); }
function setStatus(s){ statusEl.textContent=s; }
function clamp(v){ v=Number(v)||0; return Math.max(MIN, Math.min(MAX, Math.round(v))); }
function toTenths2(c){ const t=Math.round(c*10); const b=new ArrayBuffer(2); new DataView(b).setUint16(0,t,true); return new Uint8Array(b); }
function toTenths4(c){ const t=Math.round(c*10); const b=new ArrayBuffer(4); new DataView(b).setUint32(0,t,true); return new Uint8Array(b); }
function hex(u8){ return Array.from(u8).map(b=>b.toString(16).padStart(2,'0')).join(' '); }

/* smart write: with-response if supported, else no-response */
async function writeSmart(ch, bytes){
  try{
    if(ch.properties.write && ch.writeValue){ await ch.writeValue(bytes); }
    else { await ch.writeValueWithoutResponse(bytes); }
  }catch(e){
    if(ch.writeValueWithoutResponse){ await ch.writeValueWithoutResponse(bytes); }
    else throw e;
  }
}

/* cache lookup by char UUID */
function getCharByUUID(uuid){
  for(const [key,ch] of chars.entries()){
    if(key.endsWith('|'+uuid)) return ch;
  }
  throw new Error('Characteristic not found: '+uuid);
}

/* subscribe helper */
async function subscribeIf(ch, cb){
  try{
    if(ch && (ch.properties.notify || ch.properties.indicate)){
      await ch.startNotifications();
      ch.addEventListener('characteristicvaluechanged', e => cb(e.target.value));
    }
  }catch(e){ log('subscribe failed: '+e); }
}

/* -------- connect & discover -------- */
async function connect(){
  if(!navigator.bluetooth){ alert('Use Bluefy/WebBLE on iPhone.'); return; }
  setStatus('Scanning…');
  device = await navigator.bluetooth.requestDevice({ acceptAllDevices:true });
  devName.textContent = device.name || device.id || 'Volcano';
  setStatus('Connecting…');
  server = await device.gatt.connect();
  setStatus('Connected');
  await discoverAll();
  setStatus('Ready');
}

async function discoverAll(){
  chars.clear(); discovered=false;
  const services = await server.getPrimaryServices();
  for(const svc of services){
    try{
      const chs = await svc.getCharacteristics();
      for(const ch of chs){
        const key = `${svc.uuid}|${ch.uuid}`;
        chars.set(key, ch);
        log(`FOUND ${key} props=${JSON.stringify({
          read:!!ch.properties.read,
          write:!!(ch.properties.write||ch.properties.writeWithoutResponse),
          notify:!!ch.properties.notify
        })}`);
        if(ch.properties.read){
          try{
            const v=await ch.readValue();
            log(`READ ${key} = [${Array.from(new Uint8Array(v.buffer)).join(', ')}]`);
          }catch{}
        }
      }
    }catch{}
  }
  // Auto-sub Temp + Setpoint notifies
  try{
    const chT = getCharByUUID(charTempN.value.trim());
    await subscribeIf(chT, dv=>{
      if(dv.byteLength>=2){
        const t = new DataView(dv.buffer).getInt16(0,true)/10;
        if(isFinite(t)) curTemp.textContent = t.toFixed(1);
      }
      log(`[temp] ${hex(new Uint8Array(dv.buffer))}`);
    });
  }catch(e){ log('temp notify sub failed: '+e); }
  try{
    const chS = getCharByUUID(charSpN.value.trim());
    await subscribeIf(chS, dv=>{
      if(dv.byteLength>=2){
        const s=new DataView(dv.buffer).getInt16(0,true);
        if(isFinite(s)) spEl.textContent=s;
      }
      log(`[setpoint] ${hex(new Uint8Array(dv.buffer))}`);
    });
  }catch(e){ log('setpoint notify sub failed: '+e); }

  discovered=true;
  log('Discovery complete.');
}

/* -------- actions -------- */
async function setTemp(){
  try{
    if(!discovered) await discoverAll();
    const c = clamp(inpSet.value);
    spEl.textContent = c;
    const ch = getCharByUUID(charSpW.value.trim());
    try{ await writeSmart(ch, toTenths2(c)); }
    catch{ await writeSmart(ch, toTenths4(c)); }
    log(`→ setpoint write ${c} °C`);
  }catch(e){ log('Set temp error: '+e); alert('Set temp failed: '+e); }
}

/* try multiple payload variants for toggles */
const PRESS_VARIANTS = [
  new Uint8Array([0x01]),
  new Uint8Array([0x01,0x00]),
  new Uint8Array([0x01,0x00,0x00,0x00]),
];
const RELEASE_VARIANTS = [
  new Uint8Array([0x00]),
  new Uint8Array([0x00,0x00]),
  new Uint8Array([0x00,0x00,0x00,0x00]),
];

async function pulseUUID(uuid,label){
  try{
    const ch = getCharByUUID(uuid);
    // try all variants until one doesn't throw
    let ok=false;
    for(let i=0;i<PRESS_VARIANTS.length && !ok;i++){
      try{
        await writeSmart(ch, PRESS_VARIANTS[i]);
        await new Promise(r=>setTimeout(r,150));
        await writeSmart(ch, RELEASE_VARIANTS[i]);
        ok=true;
        log(`→ ${label} pulse sent (${uuid}) using variant ${i+1}`);
      }catch(_){ /* try next */ }
    }
    if(!ok) throw new Error('all payload variants failed');
  }catch(e){ log(`${label} error: ${e}`); alert(`${label} failed: ${e}`); }
}

async function toggleHeater(){ await pulseUUID(charHeater.value.trim(),'heater'); }
async function toggleFan(){ await pulseUUID(charFan.value.trim(),'fan'); }

/* brute probe known families to find a working toggle, store in mapping */
const PROBE_CANDIDATES = [
  "1011000F-5354-4F52-5A26-4249434B454C",
  "1011000C-5354-4F52-5A26-4249434B454C",
  "1010000C-5354-4F52-5A26-4249434B454C",
  "1010000D-5354-4F52-5A26-4249434B454C",
  "10130001-5354-4F52-5A26-4249434B454C",
  "10130002-5354-4F52-5A26-4249434B454C",
  "10130003-5354-4F52-5A26-4249434B454C",
  "10130004-5354-4F52-5A26-4249434B454C",
  "10130005-5354-4F52-5A26-4249434B454C",
  "10130006-5354-4F52-5A26-4249434B454C",
  "10130007-5354-4F52-5A26-4249434B454C",
  "10130008-5354-4F52-5A26-4249434B454C",
  "10130009-5354-4F52-5A26-4249434B454C",
  "1013000A-5354-4F52-5A26-4249434B454C",
  "1013000B-5354-4F52-5A26-4249434B454C",
  "101300FF-5354-4F52-5A26-4249434B454C"
];

async function probeToggles(){
  if(!discovered) await discoverAll();
  const worked=[];
  for(const u of PROBE_CANDIDATES){
    try{
      const ch = getCharByUUID(u);
      for(let i=0;i<PRESS_VARIANTS.length;i++){
        try{
          await writeSmart(ch, PRESS_VARIANTS[i]);
          await new Promise(r=>setTimeout(r,180));
          await writeSmart(ch, RELEASE_VARIANTS[i]);
          log(`[probe] pulse OK on ${u} (variant ${i+1})`);
          worked.push([u,i+1]);
          break;
        }catch{}
      }
    }catch{}
  }
  if(worked.length){
    // heuristically assign first two to heater/fan if user hasn't set them
    if(!charHeater.value && worked[0]) charHeater.value = worked[0][0];
    if(!charFan.value && worked[1])    charFan.value    = worked[1][0];
    alert(`Probe done. Found ${worked.length} candidates. Check which ones actually moved the device and set Heater/Fan fields, then Save.`);
  }else{
    alert('Probe complete: no obvious toggle responded. Try Monitor and press physical buttons.');
  }
}

/* monitor: subscribe to every notify to watch which UUIDs fire when pressing device buttons */
async function monitorAll(){
  if(!discovered) await discoverAll();
  for (const [key,ch] of chars.entries()){
    try{
      if (ch.properties.notify || ch.properties.indicate){
        await ch.startNotifications();
        ch.addEventListener('characteristicvaluechanged', e=>{
          const uuid = key.split('|')[1];
          const arr = new Uint8Array(e.target.value.buffer);
          log(`[notify] ${uuid} = ${hex(arr)}`);
        });
      }
    }catch{}
  }
  alert('Monitoring all notifies. Press Fan/Heater on the Volcano and watch Logs for the UUIDs that change.');
}

/* -------- mapping save/clear -------- */
function saveMap(){
  const m={
    svcTemp: svcTemp.value.trim(),
    charTempN: charTempN.value.trim(),
    charSpN: charSpN.value.trim(),
    charSpW: charSpW.value.trim(),
    charHeater: charHeater.value.trim(),
    charFan: charFan.value.trim()
  };
  localStorage.setItem('volcanoMap', JSON.stringify(m));
  log('Saved mapping.');
}
function loadMap(){
  try{
    const m=JSON.parse(localStorage.getItem('volcanoMap')||'{}');
    if(m.svcTemp)  svcTemp.value=m.svcTemp;
    if(m.charTempN)charTempN.value=m.charTempN;
    if(m.charSpN)  charSpN.value=m.charSpN;
    if(m.charSpW)  charSpW.value=m.charSpW;
    if(m.charHeater)charHeater.value=m.charHeater;
    if(m.charFan)  charFan.value=m.charFan;
  }catch{}
}
loadMap();

/* -------- wire UI -------- */
document.getElementById('btnConnect').onclick = connect;
document.getElementById('btnDiscover').onclick = async ()=>{ if(!server){alert('Connect first.');return;} await discoverAll(); };
document.getElementById('btnSet').onclick = setTemp;
document.getElementById('btnHeater').onclick = toggleHeater;
document.getElementById('btnFan').onclick    = toggleFan;
document.getElementById('btnProbe').onclick  = probeToggles;
document.getElementById('btnMonitor').onclick= monitorAll;
document.getElementById('btnSaveMap').onclick= saveMap;
document.getElementById('btnClearMap').onclick=()=>{ localStorage.removeItem('volcanoMap'); location.reload(); };
</script>
</body>
</html>
